#!/bin/bash

# =========================================

# H∆Ø·ªöNG D·∫™N & SCRIPT QU·∫¢N L√ù ·ªî ƒêƒ®A ‚Äî auto_disk_complete.txt

# Phi√™n b·∫£n 2 ‚Äî C·∫≠p nh·∫≠t: 08/10/2025

# T∆∞∆°ng th√≠ch CentOS 7, chu·∫©n Unix (LF), m√†u ANSI, splash 5s

# =========================================

# --- Splash h∆∞·ªõng d·∫´n m√†u (hi·ªÉn th·ªã 5 gi√¢y) ---

echo -e "\e[33m=========================================\e[0m"
echo -e "\e[5;1;36mH∆Ø·ªöNG D·∫™N S·ª¨ D·ª§NG NHANH ‚Äî auto_disk_complete.txt\e[0m"
echo -e "\e[33m=========================================\e[0m"
echo
echo -e "\e[32mScript qu·∫£n l√Ω ·ªï ƒëƒ©a cho CentOS 7:\e[0m"
echo " - T·∫°o / x√≥a / xem ph√¢n v√πng"
echo " - Qu·∫£n l√Ω LVM (PV/VG/LV)"
echo " - Mount & b·∫≠t quota"
echo " - C·∫•u h√¨nh quota + Samba chia s·∫ª"
echo
echo -e "\e[34mC√ÅCH D√ôNG:\e[0m"
echo "   C·∫•p quy·ªÅn & ch·∫°y:"
echo "      chmod +x auto_disk_complete.txt"
echo "      ./auto_disk_complete.txt"
echo
echo -e "\e[34mL∆ØU √ù NHANH:\e[0m"
echo " - Ch·∫°y b·∫±ng t√†i kho·∫£n root."
echo " - Sao l∆∞u d·ªØ li·ªáu tr∆∞·ªõc khi thao t√°c."
echo " - D√†nh cho m√¥i tr∆∞·ªùng LAB ho·∫∑c h·ªçc t·∫≠p."
echo -e "\e[33m=========================================\e[0m"
sleep 5
clear

# =========================================

# Script Qu·∫£n l√Ω ·ªî ƒêƒ®A cho CentOS 7 (ch√≠nh)

# =========================================

# H√†m li·ªát k√™ ·ªï ƒëƒ©a (to√†n b·ªô disk + partition)

list_disks() {
echo -e "\e[36m=== TH√îNG TIN ·ªî ƒêƒ®A TO√ÄN B·ªò ===\e[0m"
lsblk
fdisk -l | grep '^Disk /dev' || true
read -p "Nh·∫•n Enter ƒë·ªÉ ti·∫øp t·ª•c..."
}

# H√†m qu·∫£n l√Ω ph√¢n v√πng (menu ph·ª• c√≥ m√†u)

create_partition() {
    while true; do
        echo -e "\e[35m=== QU·∫¢N L√ù PH√ÇN V√ôNG ===\e[0m"
        echo -e "\e[36m1. T·∫°o ph√¢n v√πng t·ª± ƒë·ªông (khuy·∫øn ngh·ªã)\e[0m"
        echo -e "\e[36m2. M·ªü fdisk th·ªß c√¥ng\e[0m"
        echo -e "\e[36m3. Xem danh s√°ch ph√¢n v√πng (ch·ªâ partition)\e[0m"
        echo -e "\e[36m4. X√≥a to√†n b·ªô ph√¢n v√πng (d·ªçn s·∫°ch ·ªï)\e[0m"
        echo -e "\e[36m5. Quay l·∫°i menu ch√≠nh\e[0m"
        echo -e "\e[33m=======================================\e[0m"
        read -p "Ch·ªçn [1-5]: " sub_choice

        case $sub_choice in
            1)
                echo -e "\e[36m>>> Danh s√°ch ·ªï ƒëƒ©a hi·ªán c√≥:\e[0m"
                lsblk -d -o NAME,SIZE,MODEL | grep -E "disk|loop" || lsblk -d -o NAME,SIZE,MODEL
                echo
                read -p "Nh·∫≠p t√™n ·ªï ƒëƒ©a (v√≠ d·ª• /dev/sdb): " disk

                if [[ ! -b "$disk" ]]; then
                    echo "·ªî ƒëƒ©a kh√¥ng t·ªìn t·∫°i!"
                    read -p "Nh·∫•n Enter ƒë·ªÉ ti·∫øp t·ª•c..."
                    continue
                fi

                read -p "C·∫¢NH B√ÅO: To√†n b·ªô d·ªØ li·ªáu tr√™n $disk s·∫Ω b·ªã x√≥a. Ti·∫øp t·ª•c? (y/n): " confirm
                [[ "$confirm" != "y" ]] && echo "ƒê√£ h·ªßy thao t√°c." && read -p "Nh·∫•n Enter ƒë·ªÉ ti·∫øp t·ª•c..." && continue

                echo "X√≥a b·∫£ng ph√¢n v√πng c≈© v√† t·∫°o m·ªõi (GPT)..."
                parted -s "$disk" mklabel gpt || { echo "L·ªói khi t·∫°o label GPT."; read -p "Nh·∫•n Enter..."; continue; }

                echo "Nh·∫≠p danh s√°ch dung l∆∞·ª£ng ph√¢n v√πng (v√≠ d·ª•: 100M 200M 1G 2G)."
                echo -e "\e[33mL∆ØU √ù: Ch·ªâ ch·∫•p nh·∫≠n ƒë∆°n v·ªã M (megabyte) v√† G (gigabyte). Ph√¢n v√πng s·∫Ω ƒë∆∞·ª£c t·∫°o li√™n ti·∫øp, kh√¥ng ch·ªìng ch√©o.\e[0m"
                read -a sizes
                [[ "${sizes[0]}" == "q" ]] && continue

                for size in "${sizes[@]}"; do
                    if ! [[ "$size" =~ ^[0-9]+(M|G)$ ]]; then
                        echo "ƒê∆°n v·ªã kh√¥ng h·ª£p l·ªá cho $size! Ch·ªâ h·ªó tr·ª£ M ho·∫∑c G."
                        read -p "Nh·∫•n Enter ƒë·ªÉ th·ª≠ l·∫°i..."
                        continue 2
                    fi
                done

                # L·∫•y t·ªïng dung l∆∞·ª£ng ƒëƒ©a (MB, l√†m s·∫°ch k√Ω t·ª± l·∫°)
                total_size=$(parted -s "$disk" unit MB print | grep '^Disk' | awk '{print $3}' | tr -dc '0-9')
                start_mb=1  # b·∫Øt ƒë·∫ßu t·ª´ 1MB ƒë·ªÉ cƒÉn alignment 1MiB

                for size in "${sizes[@]}"; do
                    # Chuy·ªÉn k√≠ch th∆∞·ªõc sang MB
                    if [[ "$size" =~ M$ ]]; then
                        add_mb=${size%M}
                    elif [[ "$size" =~ G$ ]]; then
                        add_mb=$(( ${size%G} * 1024 ))
                    fi

                    end_mb=$(( start_mb + add_mb ))

                    # So s√°nh b·∫±ng c√∫ ph√°p s·ªë h·ªçc an to√†n
                    if (( end_mb > total_size )); then
                        echo "T·ªïng dung l∆∞·ª£ng v∆∞·ª£t qu√° dung l∆∞·ª£ng ƒëƒ©a!"
                        read -p "Nh·∫•n Enter ƒë·ªÉ ti·∫øp t·ª•c..."
                        break
                    fi

                    echo "T·∫°o ph√¢n v√πng t·ª´ ${start_mb}MiB ƒë·∫øn ${end_mb}MiB..."
                    parted -s "$disk" mkpart primary "${start_mb}MiB" "${end_mb}MiB" || { echo "L·ªói khi t·∫°o ph√¢n v√πng: $size."; break; }

                    partprobe "$disk" || true
                    start_mb=$end_mb

                    if (( start_mb >= total_size )); then
                        echo "ƒê√£ h·∫øt dung l∆∞·ª£ng ƒëƒ©a sau ph√¢n v√πng n√†y."
                        break
                    fi
                done

                echo "C·∫≠p nh·∫≠t b·∫£ng ph√¢n v√πng cu·ªëi c√πng..."
                partprobe "$disk" || { echo "L·ªói khi c·∫≠p nh·∫≠t partition table."; }
                sleep 1  # ch·ªù kernel nh·∫≠n /dev/sdbX

                echo "K·∫øt qu·∫£ sau khi t·∫°o:"
                lsblk "$disk" || true
                echo "Ho√†n t·∫•t t·∫°o ph√¢n v√πng. K√≠ch th∆∞·ªõc c√≥ th·ªÉ ch√™nh l·ªách nh·ªè do alignment."

                echo -e "\e[33mL∆ØU √ù: Ph√¢n v√πng ƒë√£ t·∫°o nh∆∞ng ch∆∞a c√≥ filesystem. Ch·ªçn menu 3 ƒë·ªÉ format.\e[0m"
                echo -e "\e[33mSau khi format, d√πng menu 5 ƒë·ªÉ mount v√† xem trong File Manager.\e[0m"
                read -p "Nh·∫•n Enter ƒë·ªÉ ti·∫øp t·ª•c..."
                ;;

            2)
                echo -e "\e[36m>>> Danh s√°ch ·ªï ƒëƒ©a:\e[0m"
                lsblk -d -o NAME,SIZE,TYPE | grep -E "disk|loop" || lsblk -d -o NAME,SIZE,TYPE
                read -p "Nh·∫≠p t√™n ·ªï ƒëƒ©a (v√≠ d·ª• /dev/sdb): " disk
                if [[ -b "$disk" ]]; then
                    fdisk "$disk"
                    partprobe "$disk"
                else
                    echo "·ªî ƒëƒ©a kh√¥ng h·ª£p l·ªá!"
                fi
                read -p "Nh·∫•n Enter ƒë·ªÉ ti·∫øp t·ª•c..."
                ;;

            3)
                echo -e "\e[36m>>> Danh s√°ch ph√¢n v√πng hi·ªán c√≥ (ch·ªâ partition):\e[0m"
                lsblk -o NAME,SIZE,TYPE,MOUNTPOINT | awk '$3 == "part" {print $0}' || lsblk -o NAME,SIZE,TYPE,MOUNTPOINT
                read -p "Nh·∫•n Enter ƒë·ªÉ ti·∫øp t·ª•c..."
                ;;

            4)
                echo -e "\e[31m>>> D·ªçn s·∫°ch ·ªï ƒëƒ©a (TO√ÄN B·ªò) \e[0m"
                lsblk -d -o NAME,SIZE,MODEL | grep -E "disk|loop" || lsblk -d -o NAME,SIZE,MODEL
                read -p "Nh·∫≠p t√™n ·ªï ƒëƒ©a c·∫ßn x√≥a to√†n b·ªô (v√≠ d·ª• /dev/sdb): " disk
                if [[ ! -b "$disk" ]]; then
                    echo "·ªî ƒëƒ©a kh√¥ng t·ªìn t·∫°i!"
                    read -p "Nh·∫•n Enter ƒë·ªÉ ti·∫øp t·ª•c..."
                    continue
                fi

                read -p "C·∫¢NH B√ÅO: T·∫•t c·∫£ d·ªØ li·ªáu v√† ph√¢n v√πng tr√™n $disk s·∫Ω b·ªã x√≥a! Ti·∫øp t·ª•c? (y/n): " confirm
                [[ "$confirm" != "y" ]] && echo "ƒê√£ h·ªßy thao t√°c." && read -p "Nh·∫•n Enter ƒë·ªÉ ti·∫øp t·ª•c..." && continue

                echo "ƒêang x√≥a b·∫£ng ph√¢n v√πng v√† d·ªØ li·ªáu ƒë·∫ßu ·ªï..."
                wipefs -a "$disk" 2>/dev/null || echo "wipefs kh√¥ng ho·∫°t ƒë·ªông, ti·∫øp t·ª•c..."
                dd if=/dev/zero of="$disk" bs=1M count=10 status=none 2>/dev/null || echo "L·ªói khi zero ƒë·∫ßu ·ªï."
                partprobe "$disk" || true
                echo "ƒê√£ d·ªçn s·∫°ch to√†n b·ªô ph√¢n v√πng tr√™n $disk."
                read -p "Nh·∫•n Enter ƒë·ªÉ ti·∫øp t·ª•c..."
                ;;

            5)
                return
                ;;
            *)
                echo "L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá!"
                sleep 1
                ;;
        esac
    done
}


# H√†m t·∫°o filesystem

create_fs() {
echo -e "\e[36m>>> Danh s√°ch ph√¢n v√πng:\e[0m"
lsblk -o NAME,SIZE,TYPE,MOUNTPOINT | awk '$3 == "part" {print $0}' || lsblk -o NAME,SIZE,TYPE,MOUNTPOINT
read -p "Nh·∫≠p ph√¢n v√πng (v√≠ d·ª• /dev/sdb1): " part
if [[ -b "$part" ]]; then
fs_existing=$(blkid -o value -s TYPE "$part" 2>/dev/null || true)
if [[ -n "$fs_existing" ]]; then
echo "Ph√¢n v√πng $part ƒë√£ c√≥ filesystem ($fs_existing)."
read -p "B·∫°n c√≥ ch·∫Øc mu·ªën format l·∫°i? (y/n): " confirm
[[ "$confirm" != "y" ]] && echo "H·ªßy format." && return
fi


    echo "Ch·ªçn lo·∫°i filesystem:"
    select fs in xfs ext4 ext3; do
        case $fs in
            xfs) mkfs.xfs -f "$part"; partprobe "$part"; break;;
            ext4) mkfs.ext4 -F "$part"; partprobe "$part"; break;;
            ext3) mkfs.ext3 -F "$part"; partprobe "$part"; break;;
            *) echo "L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá";;
        esac
    done
else
    echo "Ph√¢n v√πng $part kh√¥ng t·ªìn t·∫°i ho·∫∑c kh√¥ng h·ª£p l·ªá!"
fi
read -p "Nh·∫•n Enter ƒë·ªÉ ti·∫øp t·ª•c..."


}

# H√†m qu·∫£n l√Ω LVM (c√≥ menu ph·ª• m√†u)

manage_lvm() {
while true; do
echo -e "\e[35m=== QU·∫¢N L√ù LVM ===\e[0m"
echo -e "\e[36m1. T·∫°o Physical Volume (PV)\e[0m"
echo -e "\e[36m2. T·∫°o Volume Group (VG)\e[0m"
echo -e "\e[36m3. T·∫°o Logical Volume (LV)\e[0m"
echo -e "\e[36m4. Hi·ªÉn th·ªã th√¥ng tin PV/VG/LV\e[0m"
echo -e "\e[36m5. X√≥a PV/VG/LV\e[0m"
echo -e "\e[36m6. M·ªü r·ªông dung l∆∞·ª£ng LVM\e[0m"
echo -e "\e[36m7. Th√™m PV v√†o VG v√† m·ªü r·ªông LV\e[0m"
echo -e "\e[36m8. Quay l·∫°i menu ch√≠nh\e[0m"
echo -e "\e[33m=================================\e[0m"
read -p "Ch·ªçn [1-8]: " lvm_choice


case $lvm_choice in
    1)
        echo -e "\e[36m>>> Ch·ªçn ph√¢n v√πng ƒë·ªÉ t·∫°o PV:\e[0m"
        lsblk -o NAME,SIZE,TYPE,MOUNTPOINT | awk '$3 == "part" {print $0}' || lsblk -o NAME,SIZE,TYPE,MOUNTPOINT
        read -p "Nh·∫≠p ph√¢n v√πng (vd /dev/sdb1): " part
        if [[ -b "$part" ]]; then
            if pvs | grep -q "$part"; then
                echo "ƒê√£ l√† PV."
            else
                pvcreate "$part" && echo "T·∫°o PV th√†nh c√¥ng" || echo "pvcreate th·∫•t b·∫°i"
                pvscan || true
            fi
        else
            echo "Ph√¢n v√πng kh√¥ng t·ªìn t·∫°i!"
        fi
        ;;

    2)
        pvs -o PV_NAME,SIZE || true
        read -p "Nh·∫≠p danh s√°ch ph√¢n v√πng (vd /dev/sdb1 /dev/sdc1): " parts
        read -p "Nh·∫≠p t√™n VG (vd VolumeA): " vg
        if vgdisplay "$vg" &>/dev/null; then
            echo "VG ƒë√£ t·ªìn t·∫°i!"
        else
            vgcreate "$vg" $parts && echo "T·∫°o VG th√†nh c√¥ng" || echo "vgcreate th·∫•t b·∫°i"
            vgscan || true
        fi
        ;;

    3)
        vgs -o VG_NAME,VG_SIZE || true
        read -p "Nh·∫≠p t√™n VG: " vg
        read -p "Nh·∫≠p t√™n LV: " lv
        read -p "Nh·∫≠p dung l∆∞·ª£ng (vd 10G): " size
        read -p "Ch·ªçn filesystem (ext4/xfs) [m·∫∑c ƒë·ªãnh: xfs]: " fs
        fs=${fs:-xfs}

        if vgdisplay "$vg" &>/dev/null; then
            lvcreate -L "$size" -n "$lv" "$vg" && mkfs.$fs "/dev/$vg/$lv" && echo "ƒê√£ t·∫°o LV $lv ($fs)" || echo "lvcreate ho·∫∑c mkfs th·∫•t b·∫°i"
            lvscan || true
        else
            echo "VG kh√¥ng t·ªìn t·∫°i!"
        fi
        ;;

    4)
        echo "=== PHYSICAL VOLUMES ==="
        pvs -o pv_name,pv_size,pv_free || true
        echo "=== VOLUME GROUPS ==="
        vgs -o vg_name,vg_size,vg_free || true
        echo "=== LOGICAL VOLUMES ==="
        lvs -o lv_name,vg_name,lv_size,lv_path || true
        ;;

    5)
        echo "1. X√≥a PV"
        echo "2. X√≥a VG"
        echo "3. X√≥a LV"
        read -p "Ch·ªçn [1-3]: " del_choice
        case $del_choice in
            1)
                pvs || true
                read -p "Nh·∫≠p t√™n PV (vd /dev/sdb1): " pv
                read -p "X√°c nh·∫≠n x√≥a $pv (y/n): " ok
                [[ $ok == y ]] && pvremove -ff "$pv"
                ;;
            2)
                vgs || true
                read -p "Nh·∫≠p t√™n VG: " vg
                read -p "X√°c nh·∫≠n x√≥a $vg (y/n): " ok
                [[ $ok == y ]] && vgremove -ff "$vg"
                ;;
            3)
                lvs || true
                read -p "Nh·∫≠p LV (vd /dev/VolumeA/LV1): " lv
                if [[ "$lv" != /dev/* ]]; then lv="/dev/$lv"; fi
                read -p "X√°c nh·∫≠n x√≥a $lv (y/n): " ok
                [[ $ok == y ]] && lvremove -ff "$lv"
                ;;
            *) echo "L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá!";;
        esac
        ;;

    6)
        echo "M·ªü r·ªông Logical Volume"
        lvs -o LV_PATH,LV_SIZE || true
        read -p "Nh·∫≠p LV (vd /dev/VolumeA/LV1): " lv
        read -p "Nh·∫≠p dung l∆∞·ª£ng m·ªü r·ªông (vd 5G): " size
        lvextend -L +$size "$lv" || echo "lvextend th·∫•t b·∫°i"
        fs=$(blkid -o value -s TYPE "$lv" 2>/dev/null || true)
        if [[ "$fs" == "xfs" ]]; then
            xfs_growfs "$lv" || true
        else
            resize2fs "$lv" || true
        fi
        echo "ƒê√£ m·ªü r·ªông LV $lv"
        ;;

    7)
        echo "Th√™m PV v√†o VG v√† m·ªü r·ªông LV"
        vgs -o VG_NAME,VG_SIZE,VG_FREE || true
        read -p "Nh·∫≠p t√™n VG c·∫ßn m·ªü r·ªông: " vg
        if ! vgdisplay "$vg" &>/dev/null; then
            echo "VG kh√¥ng t·ªìn t·∫°i!"
            continue
        fi

        echo "C√°c ph√¢n v√πng ch∆∞a thu·ªôc PV n√†o:"
        lsblk -o NAME,SIZE,TYPE,MOUNTPOINT | awk '$3 == "part" {print $0}' || lsblk -o NAME,SIZE,TYPE,MOUNTPOINT
        echo
        pvs | awk '{print $1}' | grep -v 'PV' > /tmp/current_pv.txt || true
        echo "C√°c PV hi·ªán t·∫°i trong VG $vg:"
        vgs "$vg" -o PV_NAME --noheadings || true
        read -p "Nh·∫≠p ph√¢n v√πng m·ªõi c·∫ßn th√™m (vd /dev/sde5): " newpv

        if [[ ! -b "$newpv" ]]; then
            echo "Ph√¢n v√πng kh√¥ng t·ªìn t·∫°i!"
            continue
        fi

        if ! pvs | grep -q "$newpv"; then
            pvcreate "$newpv" && echo "ƒê√£ t·∫°o PV tr√™n $newpv" || echo "pvcreate th·∫•t b·∫°i"
        fi

        vgextend "$vg" "$newpv" && echo "ƒê√£ th√™m $newpv v√†o VG $vg" || echo "vgextend th·∫•t b·∫°i"

        echo
        echo "C√°c LV trong VG $vg:"
        lvs "$vg" -o LV_NAME,LV_PATH,LV_SIZE || true
        read -p "Nh·∫≠p t√™n LV c·∫ßn m·ªü r·ªông (vd LV ho·∫∑c /dev/$vg/LV): " lv
        if [[ "$lv" != /dev/* ]]; then
            lv="/dev/$vg/$lv"
        fi
        read -p "Nh·∫≠p dung l∆∞·ª£ng c·∫ßn tƒÉng (vd 2G): " size

        lvextend -L +$size "$lv" "$newpv" || echo "lvextend th·∫•t b·∫°i"
        fs=$(blkid -o value -s TYPE "$lv" 2>/dev/null || true)
        if [[ "$fs" == "xfs" ]]; then
            xfs_growfs "$lv" || true
        else
            resize2fs "$lv" || true
        fi

        echo "ƒê√£ m·ªü r·ªông LV $lv th√™m $size b·∫±ng PV $newpv"
        vgscan && lvscan || true
        ;;
    8) return ;;
    *) echo "L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá!";;
esac
read -p "Nh·∫•n Enter ƒë·ªÉ ti·∫øp t·ª•c..."


done
}

configure_mount_quota() {
echo -e "\e[36m>>> C·∫•u h√¨nh mount v√† quota\e[0m"
echo ">>> Danh s√°ch Logical Volumes:"
lvs -o LV_NAME,VG_NAME,LV_SIZE || true
read -p "Nh·∫≠p Logical Volume (v√≠ d·ª• /dev/VolumeA/LV1): " lv
read -p "Nh·∫≠p ƒë∆∞·ªùng d·∫´n th∆∞ m·ª•c mount (v√≠ d·ª• /home/Disk): " mount_dir


if [[ ! -b "$lv" ]]; then
    echo "Logical Volume $lv kh√¥ng t·ªìn t·∫°i ho·∫∑c kh√¥ng h·ª£p l·ªá!"
    read -p "Nh·∫•n Enter ƒë·ªÉ ti·∫øp t·ª•c..."
    return
fi

vg=$(echo $lv | cut -d'/' -f3)
lvname=$(echo $lv | cut -d'/' -f4)
real_lv="/dev/mapper/${vg}-${lvname}"

[[ ! -d "$mount_dir" ]] && mkdir -p "$mount_dir" && echo "ƒê√£ t·∫°o th∆∞ m·ª•c $mount_dir"

fs_type=$(blkid -o value -s TYPE "$real_lv" 2>/dev/null || true)
if [[ -z "$fs_type" ]]; then
    echo "Kh√¥ng ph√°t hi·ªán filesystem, b·∫°n c√≥ mu·ªën format $real_lv kh√¥ng?"
    read -p "(y/n): " confirm
    if [[ "$confirm" == "y" ]]; then
        read -p "Ch·ªçn lo·∫°i filesystem (ext4/xfs) [ext4]: " choice
        fs_type=${choice:-ext4}
        mkfs.$fs_type -f "$real_lv" || true
        echo "ƒê√£ format $real_lv v·ªõi $fs_type"
    else
        echo "Kh√¥ng th·ªÉ ti·∫øp t·ª•c n·∫øu ch∆∞a c√≥ filesystem!"
        return
    fi
fi
echo "Filesystem c·ªßa $real_lv l√†: $fs_type"

mountpoint -q "$mount_dir" || mount "$real_lv" "$mount_dir" || true
echo "ƒê√£ mount $real_lv v√†o $mount_dir"
chmod 777 "$mount_dir" || true

if [[ "$fs_type" == "xfs" ]]; then
    quota_opts="uquota,gquota"
else
    quota_opts="usrquota,grpquota"
fi

if ! grep -q "$real_lv" /etc/fstab; then
    echo "$real_lv $mount_dir $fs_type defaults,$quota_opts 0 0" >> /etc/fstab
    echo "ƒê√£ th√™m c·∫•u h√¨nh v√†o /etc/fstab"
fi

mount -o remount "$mount_dir" || true
echo "ƒê√£ remount $mount_dir v·ªõi quota"

if [[ "$fs_type" == "xfs" ]]; then
    echo "XFS kh√¥ng c·∫ßn quotacheck. Quota s·∫Ω ho·∫°t ƒë·ªông sau remount."
else
    quotacheck -avug || true
    quotaon -avug || true
    echo "ƒê√£ b·∫≠t quota cho $mount_dir"
fi

read -p "Nh·∫•n Enter ƒë·ªÉ ti·∫øp t·ª•c..."


}

configure_samba_anonymous() {
    echo ">>> C·∫•u h√¨nh Samba chia s·∫ª th∆∞ m·ª•c v·ªõi quy·ªÅn anonymous"

    echo "üìÇ Danh s√°ch th∆∞ m·ª•c mount hi·ªán t·∫°i:"
    mapfile -t mount_points < <(df -hT | awk 'NR>1 && $2!="tmpfs" && $2!="devtmpfs" {print $7}')
    select share_dir in "${mount_points[@]}" "Nh·∫≠p th·ªß c√¥ng"; do
        if [[ "$share_dir" == "Nh·∫≠p th·ªß c√¥ng" ]]; then
            read -p "Nh·∫≠p ƒë∆∞·ªùng d·∫´n th∆∞ m·ª•c chia s·∫ª (vd: /home/Disk): " share_dir
            break
        elif [[ -n "$share_dir" ]]; then
            break
        else
            echo "‚ùå L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá!"
        fi
    done

    [[ ! -d "$share_dir" ]] && echo "‚ö†Ô∏è Th∆∞ m·ª•c kh√¥ng t·ªìn t·∫°i!" && return

    # C√†i Samba n·∫øu ch∆∞a c√≥
    if ! rpm -q samba &>/dev/null; then
        yum install -y samba samba-client
    fi

    # Th√™m chia s·∫ª anonymous
    if ! grep -q "^\[share\]" /etc/samba/smb.conf; then
        cat <<EOL >> /etc/samba/smb.conf

[share]
   path = $share_dir
   browsable = yes
   public = yes
   writable = yes
   guest ok = yes
   create mask = 0666
   directory mask = 0777
EOL
        echo "‚úÖ ƒê√£ th√™m m·ª•c [share] v√†o smb.conf"
    fi

    # B·∫≠t anonymous mapping
    sed -i '/^\[global\]/a map to guest = Bad User' /etc/samba/smb.conf
    sed -i '/^\[global\]/a guest account = nobody' /etc/samba/smb.conf

    systemctl enable smb nmb
    systemctl restart smb nmb
    echo "‚úÖ Samba ƒë√£ kh·ªüi ƒë·ªông l·∫°i"

    # T·∫Øt firewall v√† SELinux cho lab
    systemctl stop firewalld 2>/dev/null
    systemctl disable firewalld 2>/dev/null
    sed -i 's/^SELINUX=.*/SELINUX=disabled/g' /etc/selinux/config

    echo "üåê Chia s·∫ª anonymous ƒë√£ s·∫µn s√†ng t·∫°i: //$HOSTNAME/share"
    read -p "Nh·∫•n Enter ƒë·ªÉ ti·∫øp t·ª•c..."
}
configure_quota_user() {
    echo ">>> C·∫•u h√¨nh quota cho user"

    echo "üìÇ Danh s√°ch th∆∞ m·ª•c mount hi·ªán t·∫°i:"
    mapfile -t mount_points < <(df -hT | awk 'NR>1 && $2!="tmpfs" && $2!="devtmpfs" {print $7}')
    select mount_dir in "${mount_points[@]}" "Nh·∫≠p th·ªß c√¥ng"; do
        if [[ "$mount_dir" == "Nh·∫≠p th·ªß c√¥ng" ]]; then
            read -p "Nh·∫≠p ƒë∆∞·ªùng d·∫´n mount (vd /home/Disk): " mount_dir
            break
        elif [[ -n "$mount_dir" ]]; then
            break
        else
            echo "‚ùå L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá!"
        fi
    done

    [[ ! -d "$mount_dir" ]] && echo "‚ö†Ô∏è Th∆∞ m·ª•c kh√¥ng t·ªìn t·∫°i!" && return

    echo "1. Ch·ªçn user c√≥ s·∫µn"
    echo "2. T·∫°o user m·ªõi"
    read -p "Ch·ªçn [1-2]: " choice

    case $choice in
        1)
            users=($(getent passwd | awk -F: '$3 >= 1000 && $1 != "nfsnobody" {print $1}'))
            PS3="Ch·ªçn user: "
            select user in "${users[@]}"; do
                [[ -n "$user" ]] && break
                echo "L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá!"
            done
            ;;
        2)
            read -p "Nh·∫≠p t√™n user m·ªõi: " user
            useradd "$user"
            passwd "$user"
            ;;
        *)
            echo "‚ùå L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá!" && return
            ;;
    esac

    fs_type=$(df -T "$mount_dir" | awk 'NR==2{print $2}')

    read -p "Gi·ªõi h·∫°n m·ªÅm (soft) MB: " soft_mb
    read -p "Gi·ªõi h·∫°n c·ª©ng (hard) MB: " hard_mb

    if [[ "$fs_type" == "xfs" ]]; then
        xfs_quota -x -c "limit bsoft=${soft_mb}M bhard=${hard_mb}M $user" "$mount_dir"
        xfs_quota -x -c "report -h" "$mount_dir"
    else
        soft_blocks=$((soft_mb * 1024))
        hard_blocks=$((hard_mb * 1024))
        setquota -u "$user" "$soft_blocks" "$hard_blocks" 0 0 "$mount_dir"
    fi

    echo "‚úÖ ƒê√£ g√°n quota cho $user (soft=${soft_mb}MB, hard=${hard_mb}MB)"
	smbpasswd -a "$user"
    read -p "Nh·∫•n Enter ƒë·ªÉ ti·∫øp t·ª•c..."
}

# MENU CH√çNH

while true; do
echo -e "\e[33m=== MENU CH√çNH ‚Äî QU·∫¢N L√ù ·ªî ƒêƒ®A ===\e[0m"
echo -e "\e[34m1. Li·ªát k√™ ·ªï ƒëƒ©a\e[0m"
echo -e "\e[34m2. T·∫°o ph√¢n v√πng\e[0m"
echo -e "\e[34m3. T·∫°o filesystem\e[0m"
echo -e "\e[34m4. Qu·∫£n l√Ω LVM (PV/VG/LV)\e[0m"
echo -e "\e[34m5. C·∫•u h√¨nh mount v√† quota\e[0m"
echo -e "\e[34m6. C·∫•u h√¨nh Samba chia s·∫ª\e[0m"
echo -e "\e[34m7. C·∫•u h√¨nh quota cho user\e[0m"
echo -e "\e[34m8. Tho√°t\e[0m"
echo -e "\e[33m=========================================\e[0m"
read -p "Ch·ªçn [1-7]: " choice


case $choice in
    1) list_disks ;;
    2) create_partition ;;
    3) create_fs ;;
    4) manage_lvm ;;
    5) configure_mount_quota ;;
    6) configure_samba_anonymous  ;;
	7) configure_quota_user ;;
    8) echo "Tho√°t..."; exit 0 ;;
    *) echo "L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá!"; sleep 1 ;;
esac


done
